# Changelog

Почти все изменения проекта будут документироваться в этом файле.

## [1.1.4] - 02-21-2026

### Added
- Новый безопасный режим для роутеров/OpenWRT: `router_mode` в `config.json` и CLI-флаг `--router-mode`.
- Новая политика очистки старых процессов ядра: `core_cleanup_mode` (`owned`/`all`/`none`) и CLI-флаг `--cleanup-mode`.
- Новый фильтр агрегатора по странам: `--agg-country` и ключ конфига `agg_countries`.

### Changed
- Стартовая очистка процессов ядра переведена в безопасный режим по умолчанию (`owned`): убиваются только процессы, запущенные самим чекером.
- Для `router_mode` добавлена защита от агрессивной зачистки: режим `all` автоматически понижается до `owned`.
- Агрегатор сначала пытается фильтровать страны по уже существующим меткам/тегам, и только затем делает GeoIP-lookup для оставшихся IP.

### Fixed
- Исправлен кейс, когда при выборе `mihomo` чекер мог завершать системный `mihomo`, запущенный роутером.

## [1.1.3] - 02-17-2026

### Added
- Поддержка ядра `mihomo` на уровне проекта: выбор режима `auto/xray/mihomo` через CLI (`--engine`) и интерактивное меню.
- Автоустановка `mihomo` в `xray_installer.py` (поиск релиза, выбор ассета под платформу/архитектуру, распаковка `.zip/.tar.gz/.tgz/.gz`, установка в `./bin`).
- Поддержка Clash/Mihomo YAML-подписок (`proxies:`) через `PyYAML` с конвертацией в ссылочный формат для проверки.
- Отсев по ping через `max_ping_ms` / `--max-ping` (значения выше порога автоматически исключаются).

### Changed
- Логика чтения `-f/--file` теперь обрабатывает смешанные входы: прямые ссылки и URL-подписки разворачиваются одновременно.
- Детект и логирование ядра стали прозрачнее: в логе фиксируются `Core detected (...)`, `Engine mode`, режим `mihomo`.
- Для `mihomo` включён режим проверки `1 процесс = 1 прокси`; для `xray` сохранён batch-режим.
- Список прокси перед запуском нормализуется детерминированно (стабильный порядок), добавлены диагностические строки по количеству найденных/добавленных ссылок.

### Fixed
- Исправлен баг, из-за которого URL-подписки в смешанном файле игнорировались, если уже были найдены прямые proxy-ссылки.
- Исправлен конфликт выбора ядра: при явном режиме (`xray`/`mihomo`) больше нет тихого переключения на другое ядро.
- Исправлена обработка subscription URL из файлов: убраны ложные срабатывания на посторонние ссылки внутри описательного текста.
- Улучшена совместимость с транспортами `xhttp/httpupgrade/h2` при обработке и прогоне ссылок.

## [1.1.0] - 01-08-2026

### Added
- Самообновление скрипта через модуль `updater.py`: проверка новых версий через GitHub API (releases/latest) с fallback на raw-файл `VERSION`.
- Staged-обновления `.new` + маркер `update.pending` и автоприменение обновлений при старте через `apply_pending_update_if_any()`.
- Новые ключи конфига (через `DEFAULTCONFIG`): `autoupdate`, `repo_owner`, `repo_name`, `repo_branch`.
- Авто-установка ядра Xray через модуль `xray_installer.py`: определение OS/архитектуры, скачивание релиза Xray-core, распаковка в `./bin`, выставление executable permissions, перенос `geoip.dat/geosite.dat` при наличии.
- Новые ключи конфига для ядра: `autoinstall_xray`, `xray_version` (поддержка `latest` или конкретного тега).
- CLI флаг `--no-update` для пропуска проверки обновлений при запуске.

### Changed
- Стартовый пайплайн: скрипт теперь применяет staged-апдейты до основной логики и выполняет проверку обновлений на старте (если модуль `updater` доступен).
- Детект ядра: если `xray/v2ray` не найден, скрипт пытается автоматически установить Xray и обновить `corepath` в `config.json`.

### Fixed
- Уменьшены ручные шаги при первом запуске на “чистой” машине: при отсутствии ядра предлагается (или выполняется) установка, вместо немедленного выхода с ошибкой.

## [1.0.3] - 01-05-2026

### Added
- Улучшенная нормализация URL в `cleanurl()` с поддержкой HTML entities и URL-encoding (кейсы `&amp;`, `&amp%3B`, `%26amp%3B`).
- CLI флаг `--self-test` для проверки корректности парсинга URL/параметров через `parse_qs()`.
- CLI флаг `--debug` (режим точечного дебага: `proxies_per_batch=1`, `threads=1`).
- Автосохранение артефактов падения батча: `savefailedbatch()` складывает `batch*.json` и `.log.txt` в `./failed_batches` и печатает команду воспроизведения `xray run -test -c ...`.
- Whitelist для Shadowsocks (AEAD-only) и фильтрация ссылок с неподдерживаемыми шифрами, чтобы не ломать запуск Xray. 

### Changed
- Запуск core (`runcore()`): вывод процесса теперь собирается через `stdout=PIPE` и `stderr=STDOUT` вместо глушения stdout.
- Логирование в batch-конфигах: `loglevel` повышен с `none` до `warning` для более информативных ошибок Xray.
- Обработка ошибок старта ядра в `Checker()`: вывод ошибки читается из объединённого потока/через `communicate()`, что снижает случаи `Unknown error`.
- Валидация VLESS REALITY: `pbk` проверяется через base64url-декод (строго 32 байта), `sid` нормализуется/валидируется как hex (чинится нечётная длина), `flow` отбрасывается если `security` не `tls/reality`.

### Fixed
- Исправлен баг, из-за которого параметры `security/pbk/sid/flow/type` не парсились при HTML/URL-экранировании, что приводило к генерации невалидных конфигов.
- Исправлены падения Xray с `Exit: 23`, вызванные невалидными REALITY `pbk` (теперь такие ссылки отбрасываются до генерации outbound).
- Исправлены падения Xray с `Exit: 23` на Shadowsocks из-за устаревших/неподдерживаемых cipher’ов (теперь такие SS-ссылки фильтруются).

## [] - 00-00-0000

### Added

### Changed

### Fixed
